<gp-draw>
    <div class="canvascontainer">
      <canvas if={showCanvas} id="canvas" width="800" height="800"></canvas>
    </div>
    <div class="pbar" if={isSaving}>
        <material-progressbar progress={0.5} moving={true}></material-progressbar>
    </div>
    <div if={!isSaving} class="controls {isControlsOpen?'controlsshown':''}">
        <button class="btn-control colors" onclick={showColors}>
            <svg fill="#FFFFFF" height="24" viewBox="0 0 24 24" width="24">
                <path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z" />
                <path d="M0 0h24v24H0z" fill="none" />
            </svg>
        </button>
        <button class="btn-control brush" onclick={showBrushes}>
            <svg fill="#FFFFFF" height="24" viewBox="0 0 24 24" width="24">
                <path d="M7 14c-1.66 0-3 1.34-3 3 0 1.31-1.16 2-2 2 .92 1.22 2.49 2 4 2 2.21 0 4-1.79 4-4 0-1.66-1.34-3-3-3zm13.71-9.37l-1.34-1.34c-.39-.39-1.02-.39-1.41 0L9 12.25 11.75 15l8.96-8.96c.39-.39.39-1.02 0-1.41z" />
            </svg>
        </button>
        <button class="btn-control save" onclick={save}>
            <svg fill="#FFFFFF" height="24" viewBox="0 0 24 24" width="24">
                <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z" />
            </svg>
        </button>
        <button class="btn-control save" onclick={save}>
            <svg fill="#FFFFFF" height="24" viewBox="0 0 24 24" width="24">
                <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z" />
            </svg>
        </button>
        <button class="btn-control publish" onclick={publish}>
            <icon-publish></icon-publish>
        </button>
        <button class="btn-control options {isControlsOpen?'controlsshown':''}" onclick={openControls}>
            <svg class="firstleg leg" fill="#FFFFFF" height="24" viewBox="0 0 24 24" width="24">
                <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" />
            </svg>
            <svg class="secondleg leg" fill="#FFFFFF" height="24" viewBox="0 0 24 24" width="24">
                <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" />
            </svg>
        </button>
    </div>
    <div class="bottomsheet {isBottomsheetShown?'shown':''}">
        <button class="btn-control closesheet" onclick={closeSheet}>
            <svg class="firstleg leg" fill="#FFFFFF" height="24" viewBox="0 0 24 24" width="24">
                <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" />
            </svg>
            <svg class="secondleg leg" fill="#FFFFFF" height="24" viewBox="0 0 24 24" width="24">
                <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" />
            </svg>
        </button>
        <div class="title">{sheetTitle}</div>
        <div class="sheetcontent">
            <gp-colorpicker if={currentControl==="PALLETE" } onselectchange={selectColor}></gp-colorpicker>
            <div class="brushlist" if={currentControl==="BRUSHES" }>
                <div class="brushcontrol" each={brush in brushesList} onclick={selectBrush}>
                    {brush}
                </div>
            </div>
        </div>
        <material-dialog title="Publish image" shown={isPublishPopupShown} actions={['NO','YES']} onaction={popupaction}>
          <div>
            <material-input placeholder="enter title" onchange={changeTitle}></material-input>
            <material-input placeholder="enter description"></material-input>
          </div>
        </material-dialog>
    </div>
    <script>
    var self = this;
    var imageActions = veronica.flux.Actions.getAction("ImageActions");
    var userStore = veronica.flux.Stores.getStore("UserStore");
    var imgStore = veronica.flux.Stores.getStore("ImageStore");

    this.brushesList = [
        "Simple Pencil",
        "Simple Brush",
        "Air Brush",
        "Slice Brush",
        "Radial Brush",
        "Pen Multi Stroke Brush",
        "Spray"
    ];

    this.isSaving = false;
    this.isControlsOpen = false;
    this.isBottomsheetShown = false;
    this.currentControl = "";
    this.sheetTitle = "";
    this.showingTitleInput = false;
    this.isPublishPopupShown = false;

    // Brush Variables
    var el, ctx;
    var factor = 800 / window.innerWidth;
    var selectedBrush = "Simple Pencil";
    var currentColor = "rgb(0,0,0)";
    var lastPoint;

    /* Canvas Ulitity functions */
    /* Canvas Ulitity functions ends here*/

    /* Brush Utility functions */
    function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    /* Brush Utility functions end*/

    function startDraw(e) {
        e.clientX = e.touches[0].clientX * factor;
        e.clientY = (e.touches[0].clientY - 66) * factor;
        ctx.beginPath();
        ctx.strokeStyle = currentColor;
        ctx.fillStyle = currentColor;
        ctx.moveTo(e.clientX, e.clientY);
        ctx.lineJoin = ctx.lineCap = 'round';
        ctx.shadowColor = 'transparent';
        ctx.lineWidth = 1;
        switch (selectedBrush) {
            case "Simple Pencil":
                ctx.lineWidth = 1;
                break;
            case "Simple Brush":
                ctx.lineWidth = 10;
                break;
            case "Air Brush":
                ctx.lineWidth = 10;
                ctx.shadowBlur = 10;
                ctx.shadowColor = currentColor;
                break;
            case "Pen Multi Stroke Brush":
            case "Slice Brush":
                ctx.lineWidth = 4;
                lastPoint = {
                    x: e.clientX,
                    y: e.clientY
                };
                break;
        }
    }

    function draw(e) {
        e.clientX = e.touches[0].clientX * factor;
        e.clientY = (e.touches[0].clientY - 66) * factor;
        switch (selectedBrush) {
            case "Radial Brush":
                var radgrad = ctx.createRadialGradient(e.clientX, e.clientY, 10, e.clientX, e.clientY, 20);
                radgrad.addColorStop(0, currentColor);
                radgrad.addColorStop(0.5, 'rgba(' + currentColor.substring(currentColor.indexOf('(') + 1, currentColor.indexOf(')')) + ',0.5)');
                radgrad.addColorStop(1, 'transparent');
                ctx.fillStyle = radgrad;
                ctx.fillRect(e.clientX - 20, e.clientY - 20, 40, 40);
                break;
            case "Pen Multi Stroke Brush":
                ctx.beginPath();
                ctx.moveTo(lastPoint.x - getRandomInt(0, 2), lastPoint.y - getRandomInt(0, 2));
                ctx.lineTo(e.clientX - getRandomInt(0, 2), e.clientY - getRandomInt(0, 2));
                ctx.stroke();
                ctx.moveTo(lastPoint.x, lastPoint.y);
                ctx.lineTo(e.clientX, e.clientY);
                ctx.stroke();
                ctx.moveTo(lastPoint.x + getRandomInt(0, 2), lastPoint.y + getRandomInt(0, 2));
                ctx.lineTo(e.clientX + getRandomInt(0, 2), e.clientY + getRandomInt(0, 2));
                ctx.stroke();
                lastPoint = {
                    x: e.clientX,
                    y: e.clientY
                };
                break;
            case "Slice Brush":
                ctx.beginPath();
                ctx.globalAlpha = 1;
                ctx.moveTo(lastPoint.x, lastPoint.y);
                ctx.lineTo(e.clientX, e.clientY);
                ctx.stroke();
                ctx.moveTo(lastPoint.x - 4, lastPoint.y - 4);
                ctx.lineTo(e.clientX - 4, e.clientY - 4);
                ctx.stroke();
                ctx.moveTo(lastPoint.x - 2, lastPoint.y - 2);
                ctx.lineTo(e.clientX - 2, e.clientY - 2);
                ctx.stroke();
                ctx.moveTo(lastPoint.x + 2, lastPoint.y + 2);
                ctx.lineTo(e.clientX + 2, e.clientY + 2);
                ctx.stroke();
                ctx.moveTo(lastPoint.x + 4, lastPoint.y + 4);
                ctx.lineTo(e.clientX + 4, e.clientY + 4);
                ctx.stroke();
                lastPoint = {
                    x: e.clientX,
                    y: e.clientY
                };
                break;
            default:
                ctx.lineTo(e.touches[0].clientX * factor, (e.touches[0].clientY - 66) * factor);
                ctx.stroke();
        }
    }

    function endDraw(e) {
        ctx.closePath();
    }

    function imageSaved() {
        var imgId = imgStore.getCurrentPicId();
        console.log(imgId);
        self.update({
            isSaving: false
        });
        //show toast
    }

    function imageSaveFailed() {
        self.update({
            isSaving: false
        });
        //show toast
    }

    function saveImage(){
      imageActions.saveImage(el.toDataURL(), null, null, userStore.getSessionId());
    }


    this.openControls = function(e) {
        e.preventDefault();
        self.update({
            isControlsOpen: !this.isControlsOpen
        });
    }

    this.closeSheet = function(e) {
        e && e.preventDefault();
        self.update({
            isBottomsheetShown: false,
            currentControl: "",
            sheetTitle: "",
        });
    }

    this.showColors = function(e) {
        e.preventDefault();
        self.update({
            isControlsOpen: !this.isControlsOpen,
            isBottomsheetShown: true,
            currentControl: "PALLETE",
            sheetTitle: "choose color"
        });
    }

    this.showBrushes = function(e) {
        e.preventDefault();
        self.update({
            isControlsOpen: !this.isControlsOpen,
            isBottomsheetShown: true,
            currentControl: "BRUSHES",
            sheetTitle: "choose brush"
        });
    }

    this.selectBrush = function(e) {
        selectedBrush = e.target.innerText;
        this.closeSheet(e);
    }

    this.selectColor = function(e) {
        currentColor = e;
        self.closeSheet();
    }

    this.save = function(e) {
        e.preventDefault();
        this.closeSheet(e);
        self.update({
            isSaving: true,
            isControlsOpen: false
        });
        saveImage();
    }

    this.publish = function(e){
      e.preventDefault();
      this.closeSheet(e);
      self.update({
          isPublishPopupShown: true,
          isControlsOpen: false
      });
      saveImage();
    }

    this.changeTitle=function(e){
      console.log(e);
    }


    this.popupaction=function(btnText){
      console.log("BTN:",btnText);
    }


    this.on("mount", function() {
        imgStore.subscribe("img:save:success", imageSaved);
        imgStore.subscribe("img:save:failed", imageSaveFailed);

        setTimeout(function() {
            self.update({
                showCanvas: true
            });
            selectedBrush = "Simple Pencil";
            document.body.classList.add("noscroll");
            el = document.getElementById('canvas');
            ctx = el.getContext('2d');
            el.addEventListener("touchstart", startDraw, false);
            el.addEventListener("touchmove", draw, false);
            el.addEventListener("touchend", endDraw, false);
        }, 400);

    });

    this.on("unmount", function() {
        document.body.classList.remove("noscroll");
        imgStore.unsubscribe("img:save:success", imageSaved);
        imgStore.unsubscribe("img:save:failed", imageSaveFailed);
    });
    </script>
</gp-draw>
